"use strict";(self.webpackChunkdocs=self.webpackChunkdocs||[]).push([[9311],{26534:(e,t,n)=>{n.r(t),n.d(t,{contentTitle:()=>r,default:()=>p,frontMatter:()=>o,metadata:()=>l,toc:()=>s});var i=n(87462),a=(n(67294),n(3905));n(8209);const o={},r="Troubleshooting",l={unversionedId:"troubleshooting",id:"troubleshooting",isDocsHomePage:!1,title:"Troubleshooting",description:"Android and iOS apps are not syncing, why?",source:"@site/docs/common/troubleshooting.mdx",sourceDirName:".",slug:"/troubleshooting",permalink:"/common/troubleshooting",editUrl:"https://github.com/getditto/docs/edit/main/docs/common/troubleshooting.mdx",tags:[],version:"current",frontMatter:{},sidebar:"defaultSidebar",previous:{title:"Frequently Asked Questions",permalink:"/common/faq"},next:{title:"2.0 Migration Guide",permalink:"/common/v2"}},s=[{value:"Android and iOS apps are not syncing, why?",id:"android-and-ios-apps-are-not-syncing-why",children:[{value:"Online Playground",id:"online-playground",children:[{value:"Did you copy your playground token and App ID correctly?",id:"did-you-copy-your-playground-token-and-app-id-correctly",children:[],level:4},{value:"Did your device connect to the internet?",id:"did-your-device-connect-to-the-internet",children:[],level:4},{value:"Do you have a firewall or proxy enabled that is blocking Ditto&#39;s connection to the Big Peer?",id:"do-you-have-a-firewall-or-proxy-enabled-that-is-blocking-dittos-connection-to-the-big-peer",children:[],level:4}],level:3},{value:"Online with Authentication",id:"online-with-authentication",children:[{value:"Did you follow the tutorial?",id:"did-you-follow-the-tutorial",children:[],level:4},{value:"Is the server behind <code>https</code> and open?",id:"is-the-server-behind-https-and-open",children:[],level:4},{value:"Are you implementing the delegates correctly?",id:"are-you-implementing-the-delegates-correctly",children:[],level:4},{value:"Verify that your webhook provider name is correctly copied in the Ditto portal.",id:"verify-that-your-webhook-provider-name-is-correctly-copied-in-the-ditto-portal",children:[],level:4},{value:"What are the permissions that you are returning for this client?",id:"what-are-the-permissions-that-you-are-returning-for-this-client",children:[],level:4},{value:"Is your AuthClient becoming garbage collected?",id:"is-your-authclient-becoming-garbage-collected",children:[],level:4}],level:3},{value:"How can I show how many peers are connected?",id:"how-can-i-show-how-many-peers-are-connected",children:[],level:3},{value:"Bluetooth",id:"bluetooth",children:[],level:3},{value:"Apple Wireless Direct Link, P2P-Wifi, Wifi Aware",id:"apple-wireless-direct-link-p2p-wifi-wifi-aware",children:[],level:3},{value:"Local Area Network (LAN)",id:"local-area-network-lan",children:[],level:3}],level:2},{value:"Synchronization seems slow, or comes to a halt over time",id:"synchronization-seems-slow-or-comes-to-a-halt-over-time",children:[],level:2},{value:"App is using too much memory, why?",id:"app-is-using-too-much-memory-why",children:[],level:2},{value:"Debugging Blocked Transactions",id:"debugging-blocked-transactions",children:[{value:"What is a \u201cblocked\u201d transaction?",id:"what-is-a-blocked-transaction",children:[],level:3},{value:"Read vs. Write Transactions",id:"read-vs-write-transactions",children:[],level:3},{value:"Reading the Logs",id:"reading-the-logs",children:[],level:3},{value:"Originators",id:"originators",children:[],level:3}],level:2},{value:"Causes of Blocked Transactions",id:"causes-of-blocked-transactions",children:[{value:"User blocks User",id:"user-blocks-user",children:[],level:3},{value:"User deadlocks User",id:"user-deadlocks-user",children:[],level:3},{value:"Replication blocks User",id:"replication-blocks-user",children:[],level:3},{value:"Replication blocks Replication",id:"replication-blocks-replication",children:[],level:3},{value:"User or Replication blocks Internal",id:"user-or-replication-blocks-internal",children:[],level:3}],level:2}],c={toc:s},d="wrapper";function p(e){let{components:t,...o}=e;return(0,a.kt)(d,(0,i.Z)({},c,o,{components:t,mdxType:"MDXLayout"}),(0,a.kt)("h1",{id:"troubleshooting"},"Troubleshooting"),(0,a.kt)("h2",{id:"android-and-ios-apps-are-not-syncing-why"},"Android and iOS apps are not syncing, why?"),(0,a.kt)("p",null,"If you are having trouble synchronizing devices in Ditto, follow this guide."),(0,a.kt)("p",null,"If you continue to have problems, please email us at\n",(0,a.kt)("a",{parentName:"p",href:"mailto:support@ditto.live"},"support@ditto.live")," or ",(0,a.kt)("a",{parentName:"p",href:"https://portal.ditto.live"},"login to your Ditto\naccount")," to chat with the support bot in the lower\nright corner of your screen. An engineer will reach out to you shortly."),(0,a.kt)("ol",null,(0,a.kt)("li",{parentName:"ol"},"Set ",(0,a.kt)("inlineCode",{parentName:"li"},"DittoLogger.minimumLogLevel")," to ",(0,a.kt)("inlineCode",{parentName:"li"},"Debug")," before you initialize ",(0,a.kt)("inlineCode",{parentName:"li"},"Ditto(identity)"),"."),(0,a.kt)("li",{parentName:"ol"},"Look at the logs. Do you see any helpful errors or warnings?"),(0,a.kt)("li",{parentName:"ol"},"Verify that your app id is the same on all devices")),(0,a.kt)("p",null,"If there is nothing in the logs, see the following sections for more information."),(0,a.kt)("h3",{id:"online-playground"},"Online Playground"),(0,a.kt)("h4",{id:"did-you-copy-your-playground-token-and-app-id-correctly"},"Did you copy your playground token and App ID correctly?"),(0,a.kt)("ol",null,(0,a.kt)("li",{parentName:"ol"},"Login to the ",(0,a.kt)("a",{parentName:"li",href:"https://portal.ditto.live"},"Portal")," "),(0,a.kt)("li",{parentName:"ol"},"Go to your App."),(0,a.kt)("li",{parentName:"ol"},"Make sure that the portal playground token is the same as the value you are using in your code.")),(0,a.kt)("p",null,(0,a.kt)("img",{alt:"Online Playground enabled in the Ditto Portal",src:n(21035).Z})),(0,a.kt)("h4",{id:"did-your-device-connect-to-the-internet"},"Did your device connect to the internet?"),(0,a.kt)("p",null,(0,a.kt)("inlineCode",{parentName:"p"},"OnlinePlayground")," applications must connect to the Big Peer first\n",(0,a.kt)("em",{parentName:"p"},"before")," going offline. ",(0,a.kt)("a",{parentName:"p",href:"./mesh-network/online-playground"},"Read more about online playground"),"."),(0,a.kt)("h4",{id:"do-you-have-a-firewall-or-proxy-enabled-that-is-blocking-dittos-connection-to-the-big-peer"},"Do you have a firewall or proxy enabled that is blocking Ditto's connection to the Big Peer?"),(0,a.kt)("p",null,"A proxy may either either block connections or cause errors in the log by substituting its own\nTLS certificate: ",(0,a.kt)("inlineCode",{parentName:"p"},"invalid certificate: UnknownIssuer"),". If you see this log message you will either\nneed to get Ditto unblocked or add the CA certificate to the Small Peer's trusted certificate store."),(0,a.kt)("p",null,"Verify that you can reach the following endpoints. You should see the output exactly as written below:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},"> nc -v MY_APP_ID.cloud.ditto.live 443\nConnection to MY_APP_ID.cloud.ditto.live port 443 [tcp/https] succeeded!\n^C\n")),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},"> curl -i https://MY_APP_ID.cloud.ditto.live/_ditto/auth/login\nHTTP/1.1 405 Method Not Allowed\nDate: Fri, 30 Sep 2022 02:03:36 GMT\nContent-Type: text/plain; charset=utf-8\nContent-Length: 23\nConnection: keep-alive\nAccess-Control-Allow-Origin: *\nAccess-Control-Allow-Credentials: true\nAccess-Control-Allow-Methods: GET, PUT, POST, DELETE, PATCH, OPTIONS\nAccess-Control-Allow-Headers: X-DITTO-ENSURE-INSERT,X-HYDRA-ENSURE-INSERT,X-DITTO-CLIENT-ID,X-HYDRA-CLIENT-ID,Accept,Referer,Keep-Alive,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Authorization,X-Forwarded-For\nAccess-Control-Max-Age: 1728000\n\nHTTP method not allowed% \n")),(0,a.kt)("p",null,"If this test passes, next check to see if WebSockets are blocked on your\nmachine. Some corporate networks, firewalls, or proxies block the HTTP upgrade\npacket that tells the WebSocket server to keep the connection alive. Check with\nyour IT administrator to see if your computer is configured to block WebSocket connections."),(0,a.kt)("h3",{id:"online-with-authentication"},"Online with Authentication"),(0,a.kt)("div",{className:"admonition admonition-info alert alert--info"},(0,a.kt)("div",{parentName:"div",className:"admonition-heading"},(0,a.kt)("h5",{parentName:"div"},(0,a.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,a.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"14",height:"16",viewBox:"0 0 14 16"},(0,a.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"}))),"info")),(0,a.kt)("div",{parentName:"div",className:"admonition-content"},(0,a.kt)("p",{parentName:"div"},"Verify this isn't simply a permission misconfiguration issue. Are you able to\ntry the operations with global read and write permission to verify it succeeds\nin this case? That could narrow down what's going on."))),(0,a.kt)("h4",{id:"did-you-follow-the-tutorial"},"Did you follow the ",(0,a.kt)("a",{parentName:"h4",href:"./security/authentication#tutorial"},"tutorial"),"?"),(0,a.kt)("p",null,"The tutorial is your best guide for implementing this correctly. See the ",(0,a.kt)("a",{parentName:"p",href:"https://github.com/getditto/samples/tree/main/authentication"},"code on GitHub for a complete working example"),"."),(0,a.kt)("h4",{id:"is-the-server-behind-https-and-open"},"Is the server behind ",(0,a.kt)("inlineCode",{parentName:"h4"},"https")," and open?"),(0,a.kt)("p",null,"Ensure that Ditto's Big Peer server hosted in the United States on AWS can send a POST request to your authentication server. "),(0,a.kt)("h4",{id:"are-you-implementing-the-delegates-correctly"},"Are you implementing the delegates correctly?"),(0,a.kt)("p",null,(0,a.kt)("inlineCode",{parentName:"p"},"authenticationExpiringSoon")," and ",(0,a.kt)("inlineCode",{parentName:"p"},"authenticationRequired")," both need to be\nimplemented according to the ",(0,a.kt)("a",{parentName:"p",href:"./security/authentication#creating-your-client"},"sample\ncode"),"."),(0,a.kt)("p",null,"Do not create subscriptions inside the callbacks. These callbacks are only\ncalled on first launch and when the certificate expires."),(0,a.kt)("h4",{id:"verify-that-your-webhook-provider-name-is-correctly-copied-in-the-ditto-portal"},"Verify that your webhook provider name is ",(0,a.kt)("a",{parentName:"h4",href:"./security/authentication#login"},"correctly copied in the Ditto portal"),"."),(0,a.kt)("p",null,"The provider name given to the Ditto Client must match a provider name in the Portal (e.g., ",(0,a.kt)("inlineCode",{parentName:"p"},"my-auth"),")."),(0,a.kt)("p",null,(0,a.kt)("img",{alt:"Sample Authentication Webhook Endpoint in the Portal",src:n(35554).Z})),(0,a.kt)("h4",{id:"what-are-the-permissions-that-you-are-returning-for-this-client"},"What are the permissions that you are returning for this client?"),(0,a.kt)("p",null,"Are the permissions allowing write and read access to the collection? Are you able to try the operations with global read and write permission to verify it succeeds in this case?"),(0,a.kt)("h4",{id:"is-your-authclient-becoming-garbage-collected"},"Is your AuthClient becoming garbage collected?"),(0,a.kt)("p",null,"Ensure that you keep a reference to the AuthClient in scope for the duration that Ditto is also active.  You should attach the dittoAuth variable to the object so it does not get garbage collected. "),(0,a.kt)("p",null,"For example:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},"namespace Sync {\n    public class DittoClient {\n        private Ditto ditto;\n+       private DittoAuthDelegate dittoAuthDelegate;\n\n        public DittoClient(string appId, string id, string jwt) {\n+          dittoAuthDelegate = new DittoAuthDelegate(id, jwt);\n           ditto = new Ditto(identity);\n        }\n       ...\n   }\n}\n")),(0,a.kt)("h3",{id:"how-can-i-show-how-many-peers-are-connected"},"How can I show how many peers are connected?"),(0,a.kt)("p",null,"DItto offers an API that you can use to watch all of the peers and their\nrespective transports that are connected to the current Ditto instance. Use the\n",(0,a.kt)("inlineCode",{parentName:"p"},"ditto.presence")," API to get real-time updates whenever Ditto's network topology\nchanges. "),(0,a.kt)("h3",{id:"bluetooth"},"Bluetooth"),(0,a.kt)("ol",null,(0,a.kt)("li",{parentName:"ol"},"Turn Use Location on"),(0,a.kt)("li",{parentName:"ol"},"Turn Bluetooth Scanning on"),(0,a.kt)("li",{parentName:"ol"},"Are permissions set correctly? See ",(0,a.kt)("a",{parentName:"li",href:"../installation"},"installation"),"."),(0,a.kt)("li",{parentName:"ol"},"Go to your OS-level permissions for Bluetooth and clear the app permissions for your application."),(0,a.kt)("li",{parentName:"ol"},"Delete the app, install it again, and open it. Does it ask for Bluetooth permissions?"),(0,a.kt)("li",{parentName:"ol"},"Android only: are you calling ",(0,a.kt)("inlineCode",{parentName:"li"},"ditto.refreshPermissions()"),"?")),(0,a.kt)("h3",{id:"apple-wireless-direct-link-p2p-wifi-wifi-aware"},"Apple Wireless Direct Link, P2P-Wifi, Wifi Aware"),(0,a.kt)("ol",null,(0,a.kt)("li",{parentName:"ol"},"Are permissions set correctly? See ",(0,a.kt)("a",{parentName:"li",href:"../installation"},"installation"),"."),(0,a.kt)("li",{parentName:"ol"},"Go to your OS-level permissions and clear the app permissions for your application."),(0,a.kt)("li",{parentName:"ol"},"Delete the app, install it again, and open it. Does it ask for location permissions?"),(0,a.kt)("li",{parentName:"ol"},"If you are using a custom ",(0,a.kt)("inlineCode",{parentName:"li"},"TransportConfig"),", make sure you have enabled all peer-to-peer transports using ",(0,a.kt)("inlineCode",{parentName:"li"},"enableAllPeerToPeer()"),".")),(0,a.kt)("h3",{id:"local-area-network-lan"},"Local Area Network (LAN)"),(0,a.kt)("ol",null,(0,a.kt)("li",{parentName:"ol"},"Are permissions set correctly? See ",(0,a.kt)("a",{parentName:"li",href:"../installation"},"installation"),"."),(0,a.kt)("li",{parentName:"ol"},"Are both devices connected to the same WiFi network?"),(0,a.kt)("li",{parentName:"ol"},"Check your router settings and see the ",(0,a.kt)("a",{parentName:"li",href:"./mesh-network/supported-transports/#local-area-network"},"LAN troubleshooting guide"),".")),(0,a.kt)("h2",{id:"synchronization-seems-slow-or-comes-to-a-halt-over-time"},"Synchronization seems slow, or comes to a halt over time"),(0,a.kt)("p",null,"Ensure that you are only creating a fixed number of live queries, with a smaller amount of data. Do not use ",(0,a.kt)("inlineCode",{parentName:"p"},"findAll()"),". "),(0,a.kt)("h2",{id:"app-is-using-too-much-memory-why"},"App is using too much memory, why?"),(0,a.kt)("p",null,"Use profiling tools for your platform to better understand where the memory leak\nmay be occurring. "),(0,a.kt)("p",null,"A common issue we see in reactive apps is a failure to dispose of resources as\nconditions change. Your app could create a large accumulation of publishers that\ninfinitely grow. Every liveQuery and subscription in ditto must be explicitly\nstopped using the ",(0,a.kt)("inlineCode",{parentName:"p"},"stop")," or ",(0,a.kt)("inlineCode",{parentName:"p"},"cancel")," API. See ",(0,a.kt)("a",{parentName:"p",href:"./concepts/syncing-data"},"snycing data")," for more information."),(0,a.kt)("h2",{id:"debugging-blocked-transactions"},"Debugging Blocked Transactions"),(0,a.kt)("div",{className:"admonition admonition-info alert alert--info"},(0,a.kt)("div",{parentName:"div",className:"admonition-heading"},(0,a.kt)("h5",{parentName:"div"},(0,a.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,a.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"14",height:"16",viewBox:"0 0 14 16"},(0,a.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"}))),"info")),(0,a.kt)("div",{parentName:"div",className:"admonition-content"},(0,a.kt)("p",{parentName:"div"},"\ud83d\udca1 This section only discusses blocked transactions on ",(0,a.kt)("strong",{parentName:"p"},"native")," platforms (e.g. iOS, Android, Windows, Linux). Ditto in web browsers operates sufficiently differently and isn\u2019t covered here."))),(0,a.kt)("p",null,"Blocked write transactions will automatically retry until they succeed. A\nblocked write transaction will never crash. Howewever, blocked write\ntransactions are a common cause for poor database performance. Long running blocks are\ngenerally bad since they mean that nothing else can be writing to the\ndatabase during this time. This could manifest itself as one of many problems:"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},"Unresponsive UI: an interaction might try to update a document, but is blocked by an existing write transaction"),(0,a.kt)("li",{parentName:"ul"},"Slow sync: new updates cannot be integrated into the store, since they\u2019re blocked by another write transaction")),(0,a.kt)("p",null,"A blocked write transaction can hint that something is wrong with the application code, or at a deeper level in Ditto. This page contains some tips & tricks to help understand the situation."),(0,a.kt)("p",null,"The process of unblocking is automatic and you don\u2019t need to write any code to handle this. However, you can drastically reduce the chance of blocking transactions by ",(0,a.kt)("strong",{parentName:"p"},"making sure a device is only syncing the data it really needs"),"."),(0,a.kt)("h3",{id:"what-is-a-blocked-transaction"},"What is a \u201cblocked\u201d transaction?"),(0,a.kt)("p",null,"At any given time, there can be only one write transaction. Any subsequent\nattempts to open another write transaction will become blocked\nuntil the existing write transaction finishes. "),(0,a.kt)("h3",{id:"read-vs-write-transactions"},"Read vs. Write Transactions"),(0,a.kt)("p",null,"Read transactions operate differently to write transactions."),(0,a.kt)("p",null,"Read transactions cannot be blocked and can run in parallel with write transactions. Read transactions don\u2019t block each other, don\u2019t block write transactions, and aren\u2019t blocked by write transactions."),(0,a.kt)("p",null,"If a write transaction is blocked, Ditto will log a message with increasing severity every 10s."),(0,a.kt)("table",null,(0,a.kt)("thead",{parentName:"table"},(0,a.kt)("tr",{parentName:"thead"},(0,a.kt)("th",{parentName:"tr",align:null},"Time (t) a transaction has been blocked"),(0,a.kt)("th",{parentName:"tr",align:null},"Log Level"))),(0,a.kt)("tbody",{parentName:"table"},(0,a.kt)("tr",{parentName:"tbody"},(0,a.kt)("td",{parentName:"tr",align:null},"t \u2264 30s"),(0,a.kt)("td",{parentName:"tr",align:null},"DEBUG")),(0,a.kt)("tr",{parentName:"tbody"},(0,a.kt)("td",{parentName:"tr",align:null},"31s < t \u2264 120s"),(0,a.kt)("td",{parentName:"tr",align:null},"WARN")),(0,a.kt)("tr",{parentName:"tbody"},(0,a.kt)("td",{parentName:"tr",align:null},"120s < t"),(0,a.kt)("td",{parentName:"tr",align:null},"ERROR")))),(0,a.kt)("p",null,"To see these logs in the database, it\u2019s important to have a minimum log level\nset. Transactions that are blocked for over 2 minutes should always be visible\nin the logs."),(0,a.kt)("p",null,"If ",(0,a.kt)("inlineCode",{parentName:"p"},"INFO")," level is used, then ",(0,a.kt)("inlineCode",{parentName:"p"},"INFO"),", ",(0,a.kt)("inlineCode",{parentName:"p"},"WARN"),",  and ",(0,a.kt)("inlineCode",{parentName:"p"},"ERROR")," messages will all be\nincluded in the logs. This means any write transactions blocking for more than\n30s should always be visible in the logs."),(0,a.kt)("h3",{id:"reading-the-logs"},"Reading the Logs"),(0,a.kt)("p",null,"If a write transaction is blocked, the device logs will look something like the following. In this example we can see a write transaction was blocked for a total of 150s (or 2.5 minutes)."),(0,a.kt)("p",null,(0,a.kt)("img",{alt:"204421276-4eee2f5d-806d-4d0d-af3e-d96a035d97a0.png",src:n(6923).Z})),(0,a.kt)("p",null,"As time progressed, Ditto complained more and more loudly (starting with ",(0,a.kt)("inlineCode",{parentName:"p"},"DEBUG"),"\nlogs before eventually logging at ",(0,a.kt)("inlineCode",{parentName:"p"},"ERROR")," level). Eventually the existing\ntransaction finished and blocked transaction was was able to proceed."),(0,a.kt)("p",null,"The write transaction which was blocked was for a Ditto internal component. This is identified by\n",(0,a.kt)("inlineCode",{parentName:"p"},"\u201coriginator=Internal\u201d"),". "),(0,a.kt)("p",null,"The existing, long-running write transaction which was causing the block was a\nuser call in the public SDK. This is identified by\n",(0,a.kt)("inlineCode",{parentName:"p"},"\u201cblocked_by=User\u201d"),". So a user-level write transaction is blocking some internal\nworkload. This is not ",(0,a.kt)("em",{parentName:"p"},"necessarily")," a problem, as the internal system will catch up eventually."),(0,a.kt)("h3",{id:"originators"},"Originators"),(0,a.kt)("p",null,"The three values you\u2019ll see for ",(0,a.kt)("inlineCode",{parentName:"p"},"originator")," and ",(0,a.kt)("inlineCode",{parentName:"p"},"blocked_by")," are: "),(0,a.kt)("table",null,(0,a.kt)("thead",{parentName:"table"},(0,a.kt)("tr",{parentName:"thead"},(0,a.kt)("th",{parentName:"tr",align:null},"Originator / Blocked By"),(0,a.kt)("th",{parentName:"tr",align:null},"Description"))),(0,a.kt)("tbody",{parentName:"table"},(0,a.kt)("tr",{parentName:"tbody"},(0,a.kt)("td",{parentName:"tr",align:null},'\u201cUser"'),(0,a.kt)("td",{parentName:"tr",align:null},"Any user-level API which modifies data.")),(0,a.kt)("tr",{parentName:"tbody"},(0,a.kt)("td",{parentName:"tr",align:null},'\u201cInternal"'),(0,a.kt)("td",{parentName:"tr",align:null},"An internal job (presence data, DB maintenance, etc.).")),(0,a.kt)("tr",{parentName:"tbody"},(0,a.kt)("td",{parentName:"tr",align:null},'\u201cReplication"'),(0,a.kt)("td",{parentName:"tr",align:null},"Updating the store with data received via replication.")))),(0,a.kt)("h2",{id:"causes-of-blocked-transactions"},"Causes of Blocked Transactions"),(0,a.kt)("p",null,"This section presents a few examples blocked transaction scenarios, how they would appear in logs, and what they might mean."),(0,a.kt)("h3",{id:"user-blocks-user"},"User blocks User"),(0,a.kt)("p",null,"An application might block its own write transactions by performing multiple writes at the same time in different places. If one is slow (perhaps it does too much work, or perhaps it reaches out to external APIs, etc.) then the other write transactions will block until it finishes."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-swift"},'// Thread/Queue 1 (starts first):\n{\n   // Somewhere in the app, a long running write transaction exists\n   ditto.store["people"].findByID(docID).update { mutableDoc in\n    // Most update tasks are quick, but a developer might\n    // doing something slow within the update block:\n    let apiData = getDataFromASlowExternalAPICall() // <-- !!!!\n        \n    mutableDoc?["age"] = apiData.age\n    mutableDoc?["ownedCars"].set(DittoCounter())\n    mutableDoc?["ownedCars"].counter?.increment(by: apiData.count)\n   }\n}\n\n// Thread/Queue 2 (starts second):\n{\n    // Somewhere else in the app, concurrently (e.g. background thread or queue)\n    // another write transaction tries to update a document. \n    //\n    // This will block until the "people" update block above completes.\n    let docID = try! ditto.store["settings"].upsert([\n        "_id": "abc123",\n    "preference": 31,\n    ])\n}\n')),(0,a.kt)("p",null,"In logs, this scenario will look like the following:"),(0,a.kt)("p",null,(0,a.kt)("inlineCode",{parentName:"p"},"LOG_LEVEL: Waiting for write transaction (elapsed: XXs), originator=User blocked_by=User")),(0,a.kt)("p",null,"Note that ",(0,a.kt)("inlineCode",{parentName:"p"},"\u201cUser\u201d")," is blocking ",(0,a.kt)("inlineCode",{parentName:"p"},"\u201cUser\u201d"),". This ",(0,a.kt)("em",{parentName:"p"},"could")," be temporary, but it could also be a deadlock which is much worse. See below."),(0,a.kt)("h3",{id:"user-deadlocks-user"},"User deadlocks User"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-swift"},'// Start a write transaction:\nditto.store["people"].findByID(docID).update { mutableDoc in\n    // Start a write transaction _within_ a write transacton.\n    // !! Deadlocks !!\n    let docID = try! ditto.store["settings"].upsert([\n        "_id": "abc123",\n        "preference": 31,\n    ]) \n\n    // ...\n}\n')),(0,a.kt)("p",null,"You cannot start a write transaction within a write transaction. The result will be a deadlock which ",(0,a.kt)("strong",{parentName:"p"},"never")," resolves itself. This might manifest itself in the logs as: "),(0,a.kt)("p",null,(0,a.kt)("inlineCode",{parentName:"p"},"LOG_LEVEL: Waiting for write transaction (elapsed: XXs), originator=User blocked_by=User")),(0,a.kt)("p",null,"Note that User blocking User doesn\u2019t necessarily mean a deadlock. It might\nmerely be a long running write transaction and this situation might be expected\ndepending on the task. However, if the transaction never unblocks and the log\nmessages at ",(0,a.kt)("inlineCode",{parentName:"p"},"ERROR")," level continue forever - you have a strong indication that\nthere\u2019s a deadlock and should investigate the application code."),(0,a.kt)("h3",{id:"replication-blocks-user"},"Replication blocks User"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-swift"},'// Somewhere in the app, a simple enough user write transaction is happening.\n// There\'s no other user write transaction happening concurrently in the\n// app, yet the update seems blocked or slow and UI might seems slugglish\n// or unresponsive.\nlet docID = try! ditto.store["settings"].upsert([\n    "_id": "abc123",\n    "preference": 31,\n])\n')),(0,a.kt)("p",null,"From the application code, it might not be obvious what the problem is. By looking in the logs, you might get a hint. For instance:"),(0,a.kt)("p",null,(0,a.kt)("inlineCode",{parentName:"p"},"LOG_LEVEL: Waiting for write transaction (elapsed: XXs), originator=User blocked_by=Replication")),(0,a.kt)("p",null,"Here we can see that replication is blocking our user\u2019s write transaction. This might happen if we\u2019ve just received a large amount of sync data from another peer. Most commonly, happens during initial sync (either with the Big Peer, or joining a mesh for the first time, or re-joining a mesh after an extended period away)."),(0,a.kt)("p",null,"This scenario is something to be aware of, but will resolve itself automatically once the sync is complete. The user transaction will eventually unblock and continue when replication has finished updating the store.  "),(0,a.kt)("h3",{id:"replication-blocks-replication"},"Replication blocks Replication"),(0,a.kt)("p",null,"If you see the following in logs, it\u2019s an indication that one replication session with a remote peer is blocking another: "),(0,a.kt)("p",null,(0,a.kt)("inlineCode",{parentName:"p"},"LOG_LEVEL: Waiting for write transaction (elapsed: XXs), originator=Replication blocked_by=Replication")),(0,a.kt)("p",null,"This can happen when the device has received large amounts of data from multiple peers ",(0,a.kt)("strong",{parentName:"p"},"simultaneously")," and must update the database with the changes it received from each. Ditto can only update the database with sync data from remote peers one at a time, so the other updates must wait their turn."),(0,a.kt)("p",null,"This scenario is most likely to happen during a large initial sync - either with the Big Peer ",(0,a.kt)("strong",{parentName:"p"},"at the same time")," as with nearby devices, or just with ",(0,a.kt)("strong",{parentName:"p"},"multiple")," nearby devices when joining a mesh for the first time (or re-joining after an extended period away)."),(0,a.kt)("p",null,"This scenario is something to be aware of, but will resolve itself automatically once the sync is complete. You can drastically reduce the chance of this type of blocking transaction by ",(0,a.kt)("strong",{parentName:"p"},"making sure each device is only syncing the data it really needs"),"."),(0,a.kt)("h3",{id:"user-or-replication-blocks-internal"},"User or Replication blocks Internal"),(0,a.kt)("p",null,"A long running write transaction might block an internal job. This scenario will be the least obvious to spot and it might not be obvious that it\u2019s happening at all. It\u2019s also the least likely to cause actual problems."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-swift"},'// Somewhere in the app, a long running write transaction exists\nditto.store["people"].findByID(docID).update { mutableDoc in\n    // Most update tasks are quick, but you might\n    // doing something slow within the update block\n    let apiData = getDataFromASlowExternalAPICall() // <-- !!!!\n\n    mutableDoc?["age"] = apiData.age\n    mutableDoc?["ownedCars"].set(DittoCounter())\n    mutableDoc?["ownedCars"].counter?.increment(by: apiData.count)\n}\n')),(0,a.kt)("p",null,"In logs, you might see the following:"),(0,a.kt)("p",null,(0,a.kt)("inlineCode",{parentName:"p"},"LOG_LEVEL: Waiting for write transaction (elapsed: XXs), originator=Internal blocked_by=User")),(0,a.kt)("p",null,"or:"),(0,a.kt)("p",null,(0,a.kt)("inlineCode",{parentName:"p"},"LOG_LEVEL: Waiting for write transaction (elapsed: XXs), originator=Internal blocked_by=Replication")),(0,a.kt)("p",null,"i.e. something is blocking ",(0,a.kt)("inlineCode",{parentName:"p"},"Internal"),"."),(0,a.kt)("p",null,"This might not have any observable effect, but if it does, it is most likely to manifest as slow/unreliable Ditto Bus connections, an inaccurate presence viewer, or slow/unreliable multihop replication. Ditto's internal mesh presence component must persist an update every 30s for these systems to keep working. If presence can\u2019t do this because it\u2019s blocked by another write transaction, those systems will begin to to fail until presence can successfully write its next update. This scenario should automatically recover just fine once the blocking write transaction finishes."))}p.isMDXComponent=!0},21035:(e,t,n)=>{n.d(t,{Z:()=>i});const i=n.p+"assets/images/portal-playground-setting-99074a40a3741119540b4be524814aa5.png"},35554:(e,t,n)=>{n.d(t,{Z:()=>i});const i=n.p+"assets/images/sample-authentication-webhook-endpoint-bcf6ba631bbd3e5b7a4d7f9fc802d2dc.png"},6923:(e,t,n)=>{n.d(t,{Z:()=>i});const i=n.p+"assets/images/troubleshooting-bcf003363710f0246b90b4b01331942e.png"}}]);