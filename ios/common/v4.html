<!doctype html>
<html class="docs-version-current" lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.9">
<link rel="preconnect" href="https://www.google-analytics.com">
<link rel="preconnect" href="https://www.googletagmanager.com">
<script async src="https://www.googletagmanager.com/gtag/js?id=G-D8PMW3CCL2"></script>
<script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-D8PMW3CCL2",{})</script>
<link rel="search" type="application/opensearchdescription+xml" title="Ditto" href="/opensearch.xml">
<!-- Google Tag Manager -->
    <script>!function(e,t,a,n,g){e[n]=e[n]||[],e[n].push({"gtm.start":(new Date).getTime(),event:"gtm.js"});var m=t.getElementsByTagName(a)[0],r=t.createElement(a);r.async=!0,r.src="https://www.googletagmanager.com/gtm.js?id=GTM-PV7QFWF",m.parentNode.insertBefore(r,m)}(window,document,"script","dataLayer")</script>
    <!-- End Google Tag Manager -->
<script src="/js/fix-trailing-slash.js"></script><title data-react-helmet="true">4.0 Migration guide | Ditto</title><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" property="og:url" content="https://docs.ditto.live/ios/common/v4"><meta data-react-helmet="true" name="docsearch:language" content="en"><meta data-react-helmet="true" name="docsearch:version" content="current"><meta data-react-helmet="true" name="docsearch:docusaurus_tag" content="docs-ios-current"><meta data-react-helmet="true" property="og:title" content="4.0 Migration guide | Ditto"><meta data-react-helmet="true" name="description" content="Ditto version 4 (V4) will be a significant internal database upgrade compared to past versions, with performance and design"><meta data-react-helmet="true" property="og:description" content="Ditto version 4 (V4) will be a significant internal database upgrade compared to past versions, with performance and design"><link data-react-helmet="true" rel="shortcut icon" href="/img/favicon.ico/favicon.ico"><link data-react-helmet="true" rel="canonical" href="https://docs.ditto.live/ios/common/v4"><link data-react-helmet="true" rel="alternate" href="https://docs.ditto.live/ios/common/v4" hreflang="en"><link data-react-helmet="true" rel="alternate" href="https://docs.ditto.live/ios/common/v4" hreflang="x-default"><link data-react-helmet="true" rel="preconnect" href="https://F25GUUSPFJ-dsn.algolia.net" crossorigin="anonymous"><link rel="stylesheet" href="/assets/css/styles.9fa6fe62.css">
<link rel="preload" href="/assets/js/runtime~main.fb32678b.js" as="script">
<link rel="preload" href="/assets/js/main.fc7b7e9b.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div><a href="#" class="skipToContent_OuoZ">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" aria-hidden="true" width="25" height="25"><path stroke-linecap="round" stroke-linejoin="round" d="M4 6h16M4 12h16M4 18h16"></path></svg></button><a href="https://ditto.live" target="_blank" rel="noopener noreferrer" class="navbar__brand"><div class="navbar__logo"><img src="/img/logos/blue.png" alt="Ditto Logo" class="themedImage_TMUO themedImage--light_4Vu1"><img src="/img/logos/blue.png" alt="Ditto Logo" class="themedImage_TMUO themedImage--dark_uzRr"></div><b class="navbar__title">Ditto</b></a><a class="navbar__item navbar__link" href="/">Documentation</a><a href="https://github.com/getditto/samples" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><span class="inline">Example Apps</span></a><a href="https://github.com/getditto" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><span class="inline">Open Source</span></a><a href="https://github.com/getditto/docs/discussions/categories/roadmap-and-ideas" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><span class="inline">Roadmap</span></a><a class="navbar__item navbar__link" href="/changelog">Changelog</a><a class="navbar__item navbar__link" href="/faq">FAQ</a></div><div class="navbar__items navbar__items--right"><a href="https://portal.ditto.live" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><span class="inline">Login</span></a><div class="searchBox_Bc3W"><button type="button" class="DocSearch DocSearch-Button" aria-label="Search"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper docs-wrapper docs-doc-page"><div class="docPage_lDyR"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_i9tI" type="button"></button><aside class="docSidebarContainer_0YBq"><div class="sidebar_LIo8"><nav class="overflow-y-auto menu thin-scrollbar overflow-x-visible menu_oAhv menuWithAnnouncementBar_IVfW"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-undefined menu__list-item"><a class="menu__link" href="/ios/installation">Installation</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-undefined menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Tutorials</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-undefined menu__list-item"><a class="menu__link menu__link--sublist" href="#">Getting Started</a><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-NaN menu__list-item"><a class="menu__link" tabindex="0" href="/ios/common/concepts/overview">Overview</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-NaN menu__list-item"><a class="menu__link" tabindex="0" href="/ios/common/concepts/documents">Documents</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-NaN menu__list-item"><a class="menu__link" tabindex="0" href="/ios/common/concepts/writing">Writing</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-NaN menu__list-item"><a class="menu__link" tabindex="0" href="/ios/common/concepts/querying">Querying</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-NaN menu__list-item"><a class="menu__link" tabindex="0" href="/ios/common/concepts/syncing-data">Syncing</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-NaN menu__list-item"><a class="menu__link" tabindex="0" href="/ios/common/concepts/remove">Removing</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-NaN menu__list-item"><a class="menu__link" tabindex="0" href="/ios/common/concepts/schemas">Schemas</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-undefined menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Types</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-undefined menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Mesh Network</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-undefined menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Quick Tips</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-undefined menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Security</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-undefined menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Change Data Capture</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-undefined menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">How it Works</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-undefined menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Experimental</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-undefined menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">API Reference</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-undefined menu__list-item"><a class="menu__link" href="/ios/common/v3">3.0 Migration guide</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-undefined menu__list-item"><a class="menu__link menu__link--active" aria-current="page" href="/ios/common/v4">4.0 Migration guide</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-undefined menu__list-item"><a class="menu__link" href="/ios/common/troubleshooting">Troubleshooting</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-undefined menu__list-item"><a class="menu__link" href="/ios/common/faq">Frequently Asked Questions</a></li></ul></nav></div></aside><main class="docMainContainer_r8cw"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_MGa7"><div class="docItemContainer_PQH2"><article class="prose max-w-none"><div class="tocCollapsible_aw-L theme-doc-toc-mobile tocMobile_psec"><button type="button" class="clean-btn tocCollapsibleButton_zr6a">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>4.0 Migration guide</h1></header><p>Ditto version 4 (V4) will be a significant internal database upgrade compared to past versions, with performance and design
improvements. This blog post covers the most consequential change to the CRDT that powers the database.</p><p>V4 introduces <strong>AddWins</strong> CRDT merge behavior to replace the existing <strong>RemoveWins</strong> merge behavior. This is no easy feat, as we will
explain below, but we believe this change is critical for our customers to build best-in-class experiences.</p><p>In V4, the merge logic for the <code>remove</code> operation in the CRDT will change, and the new CRDT Version 4 is incompatible with Version 2.
This is not something we take lightly, and we want to stress that we don&#x27;t foresee a huge breaking change like this happening
again. We know getting all mobile users to update to the latest version of an application is challenging.</p><h3 class="anchor anchorWithStickyNavbar_y2LR" id="tldr-what-do-i-need-to-do">TLDR: What do I need to do?<a aria-hidden="true" class="hash-link" href="#tldr-what-do-i-need-to-do" title="Direct link to heading">​</a></h3><ul><li>If you are synchronizing with the Big Peer, update your code to version 3.0.x or 4.0.0. For the full V3 migration guide,
visit our <a href="/ios/common/v3">docs here</a>.</li><li>If you are on a dedicated cluster, please coordinate with us on an alternative date to deploy your big peer to V3. Email
<a href="mailto:support@ditto.live" target="_blank" rel="noopener noreferrer">support@ditto.live</a> if you need more time to upgrade to V3.</li><li>Ditto Version 4  s available for you to install today. You can use it by specifying <code>4.0.0</code> in your
language package manager.</li><li>When ready to use the new CRDT, update your code to v4 and call the feature flag <code>disableSyncWithV3()</code>.
For more information, continue reading.</li></ul><h2 class="anchor anchorWithStickyNavbar_y2LR" id="digging-into-the-details">Digging into the Details<a aria-hidden="true" class="hash-link" href="#digging-into-the-details" title="Direct link to heading">​</a></h2><h3 class="anchor anchorWithStickyNavbar_y2LR" id="what-is-removewins">What is RemoveWins?<a aria-hidden="true" class="hash-link" href="#what-is-removewins" title="Direct link to heading">​</a></h3><p>Ditto version 2 (V2) uses a CRDT with a <strong>RemoveWins</strong> merge strategy. <strong>RemoveWins</strong> applies when a peer (including the Big Peer)
concurrently removes a document while another peer updates the same document. In <strong>RemoveWins</strong>, the remove operation persists,
instead of the update operation. In other words, the concurrent update is lost.</p><p>Let<!-- -->&#x27;<!-- -->s explore a <strong>RemoveWins</strong> example to understand why this behavior causes unexpected problems. Assume two peers have synced the same
document with the following shape at T=1 in the <code>products</code> collection:</p><div class="codeBlockContainer_EiTO"><div class="codeBlockContent_X2I6 swift"><pre tabindex="0" class="prism-code language-swift codeBlock_UxnK thin-scrollbar"><code class="codeBlockLines_W6UD"><span class="token-line" style="color:#9CDCFE"><span class="token plain">{</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  &quot;_id&quot;: &quot;abc123&quot;,</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  &quot;productName&quot;: &quot;Peanuts&quot;,</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  &quot;price&quot;: 4.00</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    &quot;meta&quot;: {</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    &quot;updated_at&quot;: &quot;2023-01-17T00:16:40.890Z&quot;</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  }</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_V-PD clean-btn"><div><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" aria-hidden="true" class="w-4 h-4 inline mr-1"><path stroke-linecap="round" stroke-linejoin="round" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path></svg><span class="text-xs">Copy</span></div></button></div></div><p>Both devices go offline, and each makes a concurrent change at the same logical timestamp T=2:</p><div class="codeBlockContainer_EiTO"><div class="codeBlockContent_X2I6 swift"><pre tabindex="0" class="prism-code language-swift codeBlock_UxnK thin-scrollbar"><code class="codeBlockLines_W6UD"><span class="token-line" style="color:#9CDCFE"><span class="token plain">products</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  .findById(&quot;abc123&quot;)</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  .remove()</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_V-PD clean-btn"><div><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" aria-hidden="true" class="w-4 h-4 inline mr-1"><path stroke-linecap="round" stroke-linejoin="round" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path></svg><span class="text-xs">Copy</span></div></button></div></div><div class="codeBlockContainer_EiTO"><div class="codeBlockContent_X2I6 swift"><pre tabindex="0" class="prism-code language-swift codeBlock_UxnK thin-scrollbar"><code class="codeBlockLines_W6UD"><span class="token-line" style="color:#9CDCFE"><span class="token plain">products.upsert([</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  &quot;_id&quot;: &quot;abc123&quot;,</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  &quot;productName&quot;: &quot;Peanuts&quot;,</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  &quot;price&quot;: 4.99</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    &quot;meta&quot;: {</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    &quot;updated_at&quot;: &quot;2023-01-17T00:18:40.890Z&quot;</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  }</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">])</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_V-PD clean-btn"><div><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" aria-hidden="true" class="w-4 h-4 inline mr-1"><path stroke-linecap="round" stroke-linejoin="round" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path></svg><span class="text-xs">Copy</span></div></button></div></div><p>When the devices go back online and sync, they converge to the same state. With the RemoveWins merge strategy,
the <code>remove</code> call is destructive. The document with <code>_id=&quot;abc123&quot;</code> is no longer in the collection. As a reminder,
<code>remove</code> deletes documents from the local device <em>and all other peers.</em></p><h3 class="anchor anchorWithStickyNavbar_y2LR" id="the-problem-with-removewins">The Problem with RemoveWins<a aria-hidden="true" class="hash-link" href="#the-problem-with-removewins" title="Direct link to heading">​</a></h3><p>There is one major problem with RemoveWins — it is nearly impossible to “undo” a remove. To “undo” the <code>remove</code> with this
CRDT, the device performing the (”undo”) upsert must observe all “deletes” to win. If it misses any of them, the upsert will lose to any of the unobserved removes eventually. In production apps, it<!-- -->&#x27;<!-- -->s impossible to coordinate all devices to re-add the document at a particular time. To illustrate this problem,
remember the scenario above. If Device A is offline for some time and connects back to the network, the tombstone will become
“resurrected” — i.e., active again, and will overwrite all other changes made.</p><p>In other words, if you call <code>remove</code> on a document with a RemoveWins CRDT, your application should consider this document <em>gone</em>
<em>forever</em> throughout your system. In the above example, a device can never create a document with the same <code>_id</code> in <code>products</code>. To
make this even more complex, this behavior also applies to the Map type inside of each document. This behavior is both
destructive and unpredictable, especially in a disconnected environment where lots of devices go in and out of connectivity.</p><h3 class="anchor anchorWithStickyNavbar_y2LR" id="addwins-to-the-rescue">AddWins to the Rescue<a aria-hidden="true" class="hash-link" href="#addwins-to-the-rescue" title="Direct link to heading">​</a></h3><p>In an <strong>AddWins</strong> CRDT, any device can “undo” the remove by calling <code>upsert</code> on the document with <code>_id=abc123</code> again. Essentially,
the new <strong>AddWins</strong> merge strategy prevents documents from being erased with no recourse once any person calls <code>remove</code>.</p><h2 class="anchor anchorWithStickyNavbar_y2LR" id="how-can-i-use-addwins">How can I use AddWins?<a aria-hidden="true" class="hash-link" href="#how-can-i-use-addwins" title="Direct link to heading">​</a></h2><p>So I know what you<!-- -->&#x27;<!-- -->re thinking now. <strong>RemoveWins</strong> sounds like a bug field! How do I get this awesome new <strong>AddWins</strong> functionality?</p><p>At Ditto, customer data and the continuity of the application experience are of utmost importance to us. Because of this, we<!-- -->&#x27;<!-- -->ve
dedicated immense engineering resources to ensure customers can transition from <strong>RemoveWins</strong> to <strong>AddWins</strong>.</p><p>Below we cover each migration step in detail to ensure you can successfully make this change and begin to leverage the benefits of
<strong>AddWins</strong>.</p><h3 class="anchor anchorWithStickyNavbar_y2LR" id="ditto-versions-1-v1-and-20x-v2">Ditto Versions 1 (V1) and 2.0x (V2)<a aria-hidden="true" class="hash-link" href="#ditto-versions-1-v1-and-20x-v2" title="Direct link to heading">​</a></h3><ul><li>Both use a <strong>RemoveWins</strong> CRDT</li><li>Are not compatible with <strong>AddWins</strong></li><li>Can sync with Ditto V3</li><li>Cannot sync with Ditto V4 (which introduces <strong>AddWins</strong>)</li><li>Are both unsupported after March 23rd<ul><li>Big Peer Cloud sync will stop working unless you are on a dedicated cluster and have coordinated with us on a separate support timeline</li><li>New bug or security fixes will not be back-ported to these versions. If you need a bug fix back-ported, you need to coordinate support
with us as part of a contractual support agreement.</li><li>Offline-only license tokens, <code>offlinePlayground</code>, and <code>SharedKey</code> identities will continue to work</li></ul></li></ul><h4 class="anchor anchorWithStickyNavbar_y2LR" id="what-to-do-next"><em>What to do next?</em><a aria-hidden="true" class="hash-link" href="#what-to-do-next" title="Direct link to heading">​</a></h4><div class="admonition admonition-info alert alert--info"><div class="admonition-heading"><h5><span class="admonition-icon"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="16" viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</h5></div><div class="admonition-content"><p>If you&#x27;re on Version 1 or 2.0x, upgrade to 3.0x. For the full V3 migration guide, click <a href="https://docs.ditto.live/android/common/v3" target="_blank" rel="noopener noreferrer">here</a>.</p></div></div><h3 class="anchor anchorWithStickyNavbar_y2LR" id="ditto-version-30x-v3">Ditto Version 3.0x (V3)<a aria-hidden="true" class="hash-link" href="#ditto-version-30x-v3" title="Direct link to heading">​</a></h3><p>V3 is an intermediate version that knows how to synchronize with V2 or V4 — but not both simultaneously. V3 prepares the local data store
for the AddWins migration in V4.</p><h4 class="anchor anchorWithStickyNavbar_y2LR" id="v3-overview">V3 Overview<a aria-hidden="true" class="hash-link" href="#v3-overview" title="Direct link to heading">​</a></h4><ul><li>Uses a <strong>RemoveWins</strong> CRDT</li><li>Prepares the local data store for <strong>AddWins</strong></li><li>Can sync with both V2 and V4</li><li>Once a V3 device syncs with a V4 device, it cannot sync with a V2 device ever again</li><li>No new bug or security fixes will be back-ported to this version after March 23, 2023</li></ul><h4 class="anchor anchorWithStickyNavbar_y2LR" id="what-to-do-next-1"><em>What to do next?</em><a aria-hidden="true" class="hash-link" href="#what-to-do-next-1" title="Direct link to heading">​</a></h4><div class="admonition admonition-info alert alert--info"><div class="admonition-heading"><h5><span class="admonition-icon"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="16" viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</h5></div><div class="admonition-content"><p>Ensure all devices are on Version 3.0.x then continue to the next step of upgrading to version 4. For the full V3 migration guide, click <a href="https://docs.ditto.live/android/common/v3" target="_blank" rel="noopener noreferrer">here</a>.</p></div></div><h3 class="anchor anchorWithStickyNavbar_y2LR" id="ditto-version-4-v4">Ditto Version 4 (V4)<a aria-hidden="true" class="hash-link" href="#ditto-version-4-v4" title="Direct link to heading">​</a></h3><p>V4 can synchronize <strong>RemoveWins</strong>(V3) and <strong>AddWins</strong> changes, but it <strong>cannot sync</strong> with V2. Before you deploy the V4 SDK,
ensure all devices on your application have been updated to V3. This is an epidemic that synchronizes to all peers with
the same AppID.</p><h4 class="anchor anchorWithStickyNavbar_y2LR" id="v4-overview">V4 Overview<a aria-hidden="true" class="hash-link" href="#v4-overview" title="Direct link to heading">​</a></h4><ul><li>Can sync with V3</li><li>Cannot sync with V1 or V2</li><li>Upgrading to V4 requires no code changes, it is simply a version bump from V3 to V4</li><li>Uses a <strong>RemoveWins</strong> CRDT (by default)</li><li>You can use an <strong>AddWins</strong> CRDT with flag enabled (see below)</li></ul><h4 class="anchor anchorWithStickyNavbar_y2LR" id="what-to-do-next-2"><em>What to do next?</em><a aria-hidden="true" class="hash-link" href="#what-to-do-next-2" title="Direct link to heading">​</a></h4><div class="admonition admonition-info alert alert--info"><div class="admonition-heading"><h5><span class="admonition-icon"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="16" viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</h5></div><div class="admonition-content"><p>Ensure all devices are on Version 4, then continue to the next step of enabling <strong>AddWins</strong>.</p></div></div><h3 class="anchor anchorWithStickyNavbar_y2LR" id="ditto-version-4-with-addwins">Ditto Version 4 with AddWins<a aria-hidden="true" class="hash-link" href="#ditto-version-4-with-addwins" title="Direct link to heading">​</a></h3><p>V4 has a feature flag that when called will disable <strong>RemoveWins</strong> and enable <strong>AddWins</strong>. This feature flag
is <code>disableSyncWithV3()</code>. Once this feature flag is called, all devices in the system will transition to <strong>AddWins</strong>.
Because V3 only synchronizes <strong>RemoveWins</strong> changes, V4 clients will no longer be able to synchronize with V3 once this
flag is enabled. It<!-- -->&#x27;<!-- -->s important to ensure that all of your end-user devices have updated to V4 before calling the
feature flag. </p><h4 class="anchor anchorWithStickyNavbar_y2LR" id="overview">Overview<a aria-hidden="true" class="hash-link" href="#overview" title="Direct link to heading">​</a></h4><ul><li>AddWins can be enabled using a feature flag <code>ditto.disableSyncWithV3()</code></li><li>The feature flag is partitioned by AppID</li><li><strong>AddWins</strong> will become the default CRDT for all new apps starting in Spring 2023</li></ul><h4 class="anchor anchorWithStickyNavbar_y2LR" id="what-to-do-next-3"><em>What to do next?</em><a aria-hidden="true" class="hash-link" href="#what-to-do-next-3" title="Direct link to heading">​</a></h4><div class="admonition admonition-info alert alert--info"><div class="admonition-heading"><h5><span class="admonition-icon"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="16" viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</h5></div><div class="admonition-content"><p>Once all devices are on Version 4, enable the <strong>AddWins</strong> CRDT by calling <code>ditto.disableSyncWithV3()</code>.</p></div></div><h2 class="anchor anchorWithStickyNavbar_y2LR" id="other-things-to-know">Other Things to know<a aria-hidden="true" class="hash-link" href="#other-things-to-know" title="Direct link to heading">​</a></h2><p>There are two parts to the migration: the local SDK, and the Big Peer. You handle the Local SDK, and we will handle the Big Peer.</p><h3 class="anchor anchorWithStickyNavbar_y2LR" id="local-sdk">Local SDK<a aria-hidden="true" class="hash-link" href="#local-sdk" title="Direct link to heading">​</a></h3><ul><li>You do not need to migrate any data to the local SDK database. All you need to do is update the version number, and Ditto will migrate the data for you. </li><li>The sync system will protect the database from incoming peers that are not compatible. </li><li>You should create a notification system to let your users know when to upgrade their apps so you can nudge them to upgrade to V4 of the SDK. </li><li>Any documents you removed in earlier versions of Ditto will still be permanently removed. For example, if you call <code>find(&quot;abc123&quot;).remove()</code> in V3, and then call <code>disableSyncWithV3()</code>, the document with <code>_id=abc123</code> will still be marked as deleted as it would in a <strong>RemoveWins</strong> system. These old removes are not converted to <strong>AddWins</strong>.</li></ul><h3 class="anchor anchorWithStickyNavbar_y2LR" id="big-peer">Big Peer<a aria-hidden="true" class="hash-link" href="#big-peer" title="Direct link to heading">​</a></h3><ul><li>For multi-tenant customers, Ditto SDK V2 will no longer be able to synchronize with the Big Peer.</li><li>If you have a dedicated cluster, you can work with us on a date you would like to upgrade your Big Peer instance to support V4 with <strong>AddWins</strong>. </li></ul><h2 class="anchor anchorWithStickyNavbar_y2LR" id="faq">FAQ<a aria-hidden="true" class="hash-link" href="#faq" title="Direct link to heading">​</a></h2><p><strong>1. Can I skip a version?</strong></p><p>We highly recommend that customers with production scenarios do not skip versions. As outlined above V4 is not compatible with V2 and skipping V3 could result in devices that cannot sync. If you are in development mode only then you can skip from V1/V2 directly to V4.</p><p><strong>2. What versions are compatible?</strong></p><ul><li>V1: Syncs with V2</li><li>V2: Syncs with V1 and V3</li><li>V3: Syncs with V1 and V2 or V4</li><li>V4: Syncs with V3</li></ul><h3 class="anchor anchorWithStickyNavbar_y2LR" id="version-matrix">Version Matrix<a aria-hidden="true" class="hash-link" href="#version-matrix" title="Direct link to heading">​</a></h3><p><img alt="Ditto Version Matrix" src="/assets/images/version_matrix-fa44c1cbdb27639f7698cf1ededfb1a6.png"></p></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/getditto/docs/edit/main/docs/common/v4.mdx" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_mS5F" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_mt2f"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/common/v3"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">« <!-- -->3.0 Migration guide</div></a></div><div class="pagination-nav__item pagination-nav__item--next"></div></nav></div></div><div class="col col--3"><div class="tableOfContents_vrFS thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#tldr-what-do-i-need-to-do" class="table-of-contents__link toc-highlight">TLDR: What do I need to do?</a></li><li><a href="#digging-into-the-details" class="table-of-contents__link toc-highlight">Digging into the Details</a><ul><li><a href="#what-is-removewins" class="table-of-contents__link toc-highlight">What is RemoveWins?</a></li><li><a href="#the-problem-with-removewins" class="table-of-contents__link toc-highlight">The Problem with RemoveWins</a></li><li><a href="#addwins-to-the-rescue" class="table-of-contents__link toc-highlight">AddWins to the Rescue</a></li></ul></li><li><a href="#how-can-i-use-addwins" class="table-of-contents__link toc-highlight">How can I use AddWins?</a><ul><li><a href="#ditto-versions-1-v1-and-20x-v2" class="table-of-contents__link toc-highlight">Ditto Versions 1 (V1) and 2.0x (V2)</a></li><li><a href="#ditto-version-30x-v3" class="table-of-contents__link toc-highlight">Ditto Version 3.0x (V3)</a></li><li><a href="#ditto-version-4-v4" class="table-of-contents__link toc-highlight">Ditto Version 4 (V4)</a></li><li><a href="#ditto-version-4-with-addwins" class="table-of-contents__link toc-highlight">Ditto Version 4 with AddWins</a></li></ul></li><li><a href="#other-things-to-know" class="table-of-contents__link toc-highlight">Other Things to know</a><ul><li><a href="#local-sdk" class="table-of-contents__link toc-highlight">Local SDK</a></li><li><a href="#big-peer" class="table-of-contents__link toc-highlight">Big Peer</a></li></ul></li><li><a href="#faq" class="table-of-contents__link toc-highlight">FAQ</a><ul><li><a href="#version-matrix" class="table-of-contents__link toc-highlight">Version Matrix</a></li></ul></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Docs</div><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/">Documentation</a></li><li class="footer__item"><a href="https://www.ditto.live/" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Main Website</span></a></li><li class="footer__item"><a href="https://github.com/getditto/samples" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Example Apps</span></a></li><li class="footer__item"><a class="footer__link-item" href="/changelog">Changelog</a></li><li class="footer__item"><a href="https://portal.ditto.live" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Login</span></a></li></ul></div><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items"><li class="footer__item"><a href="https://github.com/getditto/docs/discussions" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>GitHub Discussions</span></a></li><li class="footer__item"><a href="https://github.com/getditto/docs/discussions/categories/roadmap-and-ideas" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Roadmap</span></a></li><li class="footer__item"><a href="https://github.com/getditto/" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Open Source</span></a></li><li class="footer__item"><a href="https://stackoverflow.com/questions/tagged/ditto" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Stack Overflow</span></a></li><li class="footer__item"><a href="https://twitter.com/dittolive" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Twitter</span></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2023 DittoLive, Inc. Built with Docusaurus.</div></div></div></footer></div>
<script src="/assets/js/runtime~main.fb32678b.js"></script>
<script src="/assets/js/main.fc7b7e9b.js"></script>
<!-- Google Tag Manager (noscript) -->
    <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-PV7QFWF" height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
    <!-- End Google Tag Manager (noscript) --></body>
</html>